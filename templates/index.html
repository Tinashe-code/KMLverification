<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KML Pole Number Extractor</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        padding-top: 20px;
      }
      .container {
        max-width: 800px;
      }
      .card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .preview-box {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        background-color: #f8f9fa;
      }
      .duplicate-badge {
        font-size: 0.9em;
        margin-right: 5px;
        margin-bottom: 5px;
      }
      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }
      .spinner-border {
        width: 3rem;
        height: 3rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h2 class="mb-0">KML Pole Number Extractor</h2>
        </div>
        <div class="card-body">
          <p class="card-text">
            Upload a KML file containing pole locations. The system will:
          </p>
          <ul>
            <li>Extract pole numbers from IDs (handling various formats)</li>
            <li>Sort poles by their numbers</li>
            <li>Identify duplicate pole numbers</li>
            <li>Generate a downloadable CSV file</li>
          </ul>

          <div class="mb-3">
            <label for="kmlFile" class="form-label">Upload KML File:</label>
            <input
              class="form-control"
              type="file"
              id="kmlFile"
              accept=".kml"
            />
          </div>

          <button class="btn btn-primary" onclick="uploadFile()" id="uploadBtn">
            Process KML File
          </button>

          <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Processing your KML file...</p>
          </div>

          <div id="results" style="display: none">
            <hr />
            <h4>Processing Results</h4>

            <div class="row mt-3">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Summary</h5>
                  </div>
                  <div class="card-body">
                    <p>
                      <strong>Total Poles:</strong>
                      <span id="totalPoles">0</span>
                    </p>
                    <p>
                      <strong>Duplicate Numbers Found:</strong>
                      <span id="dupCount">0</span>
                    </p>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card">
                  <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">Duplicate Pole Numbers</h5>
                  </div>
                  <div class="card-body">
                    <div id="duplicateNumbers">
                      <em>No duplicates found</em>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <h5>Sample Data (First 10 Rows)</h5>
              <div class="preview-box" id="sampleData">
                <em>No data to display</em>
              </div>
            </div>

            <div class="mt-3">
              <a
                href="#"
                class="btn btn-success"
                id="downloadBtn"
                onclick="downloadCSV()"
              >
                Download CSV File
              </a>
              <button class="btn btn-secondary" onclick="resetForm()">
                Process Another File
              </button>
            </div>
          </div>

          <div
            id="errorAlert"
            class="alert alert-danger mt-3"
            style="display: none"
          >
            <span id="errorMessage"></span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">ID Format Examples</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Input ID</th>
                <th>Extracted Number</th>
                <th>Formatted ID</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>P4 N</td>
                <td>4</td>
                <td>P4</td>
              </tr>
              <tr>
                <td>NP36 3W</td>
                <td>36</td>
                <td>P36</td>
              </tr>
              <tr>
                <td>MV 1</td>
                <td>1</td>
                <td>P1</td>
              </tr>
              <tr>
                <td>p089</td>
                <td>89</td>
                <td>P89</td>
              </tr>
              <tr>
                <td>ABC</td>
                <td>0</td>
                <td>ABC</td>
              </tr>
              <tr>
                <td>NP28 TERM</td>
                <td>28</td>
                <td>P28</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
              // Add at the top of your <script> section
      const BACKEND_URL = "https://your-render-app.onrender.com";  // Replace with actual URL

      // Update fetch calls to use BACKEND_URL
      const response = await fetch(`${BACKEND_URL}/upload-kml/`, {
          method: 'POST',
          body: formData
      });
              let currentCsvFilename = "";

              async function uploadFile() {
                  const fileInput = document.getElementById('kmlFile');
                  const file = fileInput.files[0];

                  if (!file) {
                      showError("Please select a KML file to upload.");
                      return;
                  }

                  if (!file.name.endsWith('.kml')) {
                      showError("Please upload a KML file (.kml extension).");
                      return;
                  }

                  // Show loading, hide other elements
                  document.getElementById('loading').style.display = 'block';
                  document.getElementById('results').style.display = 'none';
                  document.getElementById('errorAlert').style.display = 'none';
                  document.getElementById('uploadBtn').disabled = true;

                  const formData = new FormData();
                  formData.append('file', file);

                  try {
                      const response = await fetch('/upload-kml/', {
                          method: 'POST',
                          body: formData
                      });

                      if (!response.ok) {
                          const error = await response.json();
                          throw new Error(error.detail || "Upload failed");
                      }

                      const data = await response.json();

                      // Store CSV filename for download
                      currentCsvFilename = data.csv_filename;

                      // Update results display
                      document.getElementById('totalPoles').textContent =
                          data.processing_results.total_poles;
                      document.getElementById('dupCount').textContent =
                          data.processing_results.duplicate_count;

                      // Display duplicate numbers
                      const dupContainer = document.getElementById('duplicateNumbers');
                      if (data.processing_results.duplicate_numbers.length > 0) {
                          dupContainer.innerHTML = data.processing_results.duplicate_numbers
                              .map(num => `<span class="badge bg-danger duplicate-badge">${num}</span>`)
                              .join('');
                      } else {
                          dupContainer.innerHTML = '<em>No duplicates found</em>';
                      }

                      // Display sample data
                      const sampleContainer = document.getElementById('sampleData');
                      if (data.processing_results.sample_data.length > 0) {
                          const headers = Object.keys(data.processing_results.sample_data[0]);
                          let html = '<table class="table table-sm table-striped"><thead><tr>';
                          headers.forEach(h => html += `<th>${h}</th>`);
                          html += '</tr></thead><tbody>';

                          data.processing_results.sample_data.forEach(row => {
                              html += '<tr>';
                              headers.forEach(h => {
                                  html += `<td>${row[h]}</td>`;
                              });
                              html += '</tr>';
                          });

                          html += '</tbody></table>';
                          sampleContainer.innerHTML = html;
                      } else {
                          sampleContainer.innerHTML = '<em>No data to display</em>';
                      }

                      // Show results, hide loading
                      document.getElementById('loading').style.display = 'none';
                      document.getElementById('results').style.display = 'block';

                  } catch (error) {
                      document.getElementById('loading').style.display = 'none';
                      showError(error.message);
                  } finally {
                      document.getElementById('uploadBtn').disabled = false;
                  }
              }

              function downloadCSV() {
                  if (!currentCsvFilename) {
                      showError("No CSV file available for download.");
                      return;
                  }

                  // Trigger download
                  window.open(`/download-csv/${currentCsvFilename}`, '_blank');
              }

              function resetForm() {
                  document.getElementById('kmlFile').value = '';
                  document.getElementById('results').style.display = 'none';
                  document.getElementById('errorAlert').style.display = 'none';
                  currentCsvFilename = "";
              }

              function showError(message) {
                  document.getElementById('errorMessage').textContent = message;
                  document.getElementById('errorAlert').style.display = 'block';
              }
    </script>
  </body>
</html>
